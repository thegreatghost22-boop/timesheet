<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanny Timesheet Management System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #4CAF50;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.2em;
        }
        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }
        .nav-tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            background: #4CAF50;
            color: white;
        }
        .nav-tab:hover {
            background: #45a049;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }
        .info-box {
            text-align: center;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        .info-box .value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .timesheet-table th,
        .timesheet-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .timesheet-table th {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            font-weight: 600;
        }
        .date-cell {
            text-align: left;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .time-input {
            width: 80px;
            border: none;
            background: transparent;
            text-align: center;
            font-family: inherit;
        }
        .hours-cell {
            background-color: #e8f5e8;
            font-weight: bold;
        }
        .personal-holiday-cell {
            background-color: #fff3cd;
        }
        .family-holiday-cell {
            background-color: #fce4ec;
        }
        .bank-holiday-cell {
            background-color: #d4edda;
        }
        .toil-usage-cell {
            background-color: #e1f5fe;
        }
        .week-total {
            background-color: #d1ecf1;
            font-weight: bold;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }
        .card h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        .metric {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        .carry-forward-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196F3;
        }
        .toil-tracking-section {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #e91e63;
        }
        .holiday-tracking-section {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #9c27b0;
        }
        .proxy-parenting-section {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #f57c00;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        .data-table th {
            background: #343a40;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }
        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        .export-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .legend {
            margin: 10px 0;
            font-size: 12px;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
            padding: 3px 8px;
            border-radius: 3px;
        }
        .checklist {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .checklist-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-left: 3px solid #6c757d;
            border-radius: 3px;
        }
        .checklist-item.active {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        @media print {
            .nav-tabs, .export-section, .btn { display: none !important; }
            body { font-size: 12px; }
        }
        @media (max-width: 768px) {
            .info-section { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Nanny Timesheet Management System</h1>
            <p>Wendy Ballard - Professional Time Tracking & Payroll Management with TOIL</p>
        </div>

        <div id="statusMessage"></div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('monthly')">Monthly Timesheet</button>
            <button class="nav-tab" onclick="showTab('proxy')">Proxy Parenting</button>
            <button class="nav-tab" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('annual')">Annual Reports</button>
            <button class="nav-tab" onclick="showTab('data')">Data Management</button>
        </div>

        <!-- Monthly Timesheet Tab -->
        <div id="monthly" class="tab-content active">
            <div class="info-section">
                <div class="info-box">
                    <h3>Current Month</h3>
                    <div class="value">
                        <input type="month" id="monthSelect" value="2025-09" onchange="generateTimesheet()" style="background: transparent; border: none; color: white; font-size: 0.8em;">
                    </div>
                    <div>Â£23.00/hour | 32h/week contract</div>
                </div>
                <div class="info-box">
                    <h3>Personal Holiday</h3>
                    <div class="value"><span id="personalHolidaysRemaining">0</span>/<span id="holidaysTotal">28</span></div>
                    <div>Days remaining this year</div>
                </div>
                <div class="info-box">
                    <h3>TOIL Balance</h3>
                    <div class="value"><span id="toilBalance">0</span></div>
                    <div>Hours available</div>
                </div>
            </div>

            <div class="toil-tracking-section">
                <h3 style="margin-top: 0; color: #c2185b;">TOIL (Time Off In Lieu) Management</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>TOIL from Previous Month:</strong> 
                        <input type="number" id="toilFromPrevious" value="0" step="0.25" onchange="updateTotals(); saveData();" style="width: 60px; margin-left: 5px;"> hours<br>
                        <small>Hours carried forward to be offset by overtime</small>
                    </div>
                    <div>
                        <strong>Family Holiday This Month:</strong>
                        <input type="number" id="familyHolidayDays" value="0" min="0" step="0.5" onchange="updateTotals(); saveData();" style="width: 50px; margin-left: 5px;"> days<br>
                        <small>Creates new TOIL (doesn't reduce personal entitlement)</small>
                    </div>
                    <div>
                        <strong>TOIL Used This Month:</strong> <span id="toilUsedThisMonth">0.00</span> hours<br>
                        <small>Time off using TOIL balance</small>
                    </div>
                    <div>
                        <strong>Net TOIL to Carry Forward:</strong> <span id="toilToCarryForward">0.00</span> hours<br>
                        <small>Remaining after overtime offset</small>
                    </div>
                </div>
            </div>

            <div class="proxy-parenting-section">
                <h3 style="margin-top: 0; color: #e65100;">Proxy Parenting Tracking</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Proxy Parenting Periods:</strong>
                        <input type="number" id="proxyParentingPeriods" value="0" min="0" step="1" onchange="updateTotals(); saveData();" style="width: 50px; margin-left: 5px;"> periods<br>
                        <small>Each 7-day period = Â£1,264 additional pay</small>
                    </div>
                    <div>
                        <strong>Partial Days (under 7 days):</strong>
                        <input type="number" id="proxyParentingDays" value="0" min="0" step="0.5" onchange="updateTotals(); saveData();" style="width: 50px; margin-left: 5px;"> days<br>
                        <small>Pro-rata: Â£180.57 per day</small>
                    </div>
                    <div>
                        <strong>Total Proxy Parenting Pay:</strong> Â£<span id="proxyParentingPay">0.00</span><br>
                        <small>Over and above regular salary</small>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 12px;">
                    <strong>Note:</strong> Per Schedule 4, proxy parenting provides 24/7 care during employer isolation. 
                    Rate includes accommodation, meals, and full parental authority for routine decisions. 
                    Emergency medical decisions require employer consultation when possible.
                </div>
            </div>

            <div class="holiday-tracking-section">
                <h3 style="margin-top: 0; color: #7b1fa2;">Annual Holiday Tracking (28-Day Entitlement)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Bank Holidays This Month:</strong> 
                        <input type="number" id="currentBankHolidays" value="0" min="0" step="0.5" onchange="updateTotals(); saveData();" style="width: 50px; margin-left: 5px;"> days<br>
                        <small>Statutory holidays (reduces entitlement)</small>
                    </div>
                    <div>
                        <strong>Personal Holiday This Month:</strong> <span id="personalHolidaysThisMonth">0.00</span> days<br>
                        <small>Wendy's choice (reduces entitlement)</small>
                    </div>
                    <div>
                        <strong>Employer-Directed This Month:</strong> <span id="employerDirectedThisMonth">0.00</span> days<br>
                        <small>Your choice, paid (reduces entitlement)</small>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <strong style="font-size: 1.1em;">Year-to-Date Holiday Usage:</strong><br>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div>Bank Holidays: <strong><span id="bankHolidaysUsed">0</span> days</strong></div>
                        <div>Personal Holiday: <strong><span id="personalHolidaysUsed">0.0</span> days</strong></div>
                        <div>Employer-Directed: <strong><span id="employerDirectedUsed">0.0</span> days</strong></div>
                        <div style="color: #9c27b0; font-size: 1.1em;">Total Used: <strong><span id="totalHolidaysUsed">0.0</span> days</strong></div>
                        <div style="color: #4CAF50; font-size: 1.2em;">Remaining: <strong><span id="remainingHolidays">28.0</span> days</strong></div>
                    </div>
                </div>
            </div>

            <div class="legend">
                <span class="legend-item personal-holiday-cell"><strong>Personal Holiday</strong> - Wendy's choice from 28-day entitlement</span>
                <span class="legend-item family-holiday-cell"><strong>Family Holiday</strong> - Leave TOIL unchecked = Employer-directed paid holiday (reduces 28 days) | Check TOIL = Creates debt for future overtime offset</span>
                <span class="legend-item bank-holiday-cell"><strong>Bank Holiday</strong> - Statutory holiday (reduces 28-day entitlement)</span>
                <span class="legend-item toil-usage-cell"><strong>TOIL Usage</strong> - Using accumulated TOIL balance</span>
                <span class="legend-item" style="background-color: #fff8dc;"><strong>Weekend Days</strong> - All weekend hours count as overtime (contract is Mon-Fri)</span>
            </div>

            <table class="timesheet-table" id="timesheetTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time In</th>
                        <th>Time Out</th>
                        <th>Hours</th>
                        <th>Personal Holiday</th>
                        <th>Family Holiday</th>
                        <th>TOIL Usage</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="timesheetBody">
                    <!-- Generated content -->
                </tbody>
            </table>

            <div class="carry-forward-section">
                <h3 style="margin-top: 0; color: #1976d2;">Monthly Summary & Overtime Calculations</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Hours Worked:</strong> <span id="totalHours">0.00</span><br>
                        <strong>Contract Hours:</strong> <span id="contractHours">0.00</span><br>
                        <strong>Overtime Hours:</strong> <span id="overtimeHours">0.00</span>
                    </div>
                    <div>
                        <strong>TOIL Offset Applied:</strong> <span id="toilOffset">0.00</span> hours<br>
                        <strong>Remaining Overtime:</strong> <span id="remainingOvertime">0.00</span> hours<br>
                        <strong>Net Personal Holiday:</strong> <span id="netPersonalHolidayHours">0.00</span> hours
                    </div>
                    <div>
                        <button class="btn btn-info" onclick="saveData()" style="margin-bottom: 10px;">Save Data</button><br>
                        <strong>Total Gross Pay:</strong><br>
                        <span style="font-size: 1.5em; color: #2c3e50;">Â£<span id="totalPay">0.00</span></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>For Nannytax Submission</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>Hours Worked:</strong> <span id="submissionHours">0.00</span></div>
                    <div><strong>Regular Pay:</strong> Â£<span id="submissionPay">0.00</span></div>
                    <div><strong>Holiday Pay:</strong> Â£<span id="submissionHolidayPay">0.00</span></div>
                    <div><strong>Overtime Pay:</strong> Â£<span id="submissionOvertimePay">0.00</span></div>
                    <div><strong>Proxy Parenting:</strong> Â£<span id="submissionProxyPay">0.00</span></div>
                    <div><strong>Total Gross:</strong> Â£<span id="submissionTotal">0.00</span></div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <strong>Submission Note:</strong> Proxy parenting pay (Â£1,264 per 7-day period) is over and above regular salary per contract Schedule 4
                </div>
            </div>
        </div>

        <!-- Proxy Parenting Documentation Tab -->
        <div id="proxy" class="tab-content">
            <div class="card">
                <h3>Proxy Parenting Guidelines & Procedures</h3>
                <p><strong>Per Contract Schedule 4:</strong> Proxy parenting provides 24/7 childcare during employer isolation due to illness or emergency situations.</p>
                
                <h4 style="color: #e65100; margin-top: 20px;">Compensation</h4>
                <ul>
                    <li><strong>Full week (7 days):</strong> Â£1,264 over and above regular salary</li>
                    <li><strong>Partial week:</strong> Â£180.57 per day (pro-rata)</li>
                    <li><strong>Accommodation & meals:</strong> Provided at no cost</li>
                    <li><strong>Payment timing:</strong> With the following month's salary</li>
                </ul>

                <h4 style="color: #e65100; margin-top: 20px;">Decision-Making Authority</h4>
                <div class="checklist">
                    <div class="checklist-item active">
                        <strong>Wendy has full authority for:</strong>
                        <ul style="margin: 5px 0;">
                            <li>Daily routines (meals, naps, activities, screen time)</li>
                            <li>Minor behavioral management consistent with family guidelines</li>
                            <li>Routine appointments and activities</li>
                            <li>Emergency first aid and basic medical care</li>
                            <li>Household management (cleaning, laundry, organization)</li>
                        </ul>
                    </div>
                    <div class="checklist-item">
                        <strong>Requires your consultation:</strong>
                        <ul style="margin: 5px 0;">
                            <li>Medical decisions beyond basic first aid or routine care</li>
                            <li>Changes to established routines or schedules</li>
                            <li>Disciplinary issues beyond minor behavioral corrections</li>
                            <li>Concerns about child's physical or emotional well-being</li>
                            <li>Decisions involving third parties (playdates, activities, etc.)</li>
                        </ul>
                    </div>
                    <div class="checklist-item active">
                        <strong>Emergency protocols:</strong>
                        <ul style="margin: 5px 0;">
                            <li>Wendy authorized to seek immediate medical attention without prior consultation</li>
                            <li>Emergency contact list maintained and updated</li>
                            <li>Backup emergency contacts if you are unreachable</li>
                        </ul>
                    </div>
                </div>

                <h4 style="color: #e65100; margin-top: 20px;">Activation Checklist</h4>
                <div class="checklist">
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-notice"> <label for="proxy-notice"><strong>Notice Given:</strong> 24-hour advance notice provided (or emergency declared)</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-supplies"> <label for="proxy-supplies"><strong>Supplies Ready:</strong> Food, medications, supplies stocked</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-contacts"> <label for="proxy-contacts"><strong>Contacts Updated:</strong> Emergency contact list current</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-routines"> <label for="proxy-routines"><strong>Routines Documented:</strong> Daily schedules, preferences, behavioral strategies shared</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-medical"> <label for="proxy-medical"><strong>Medical Info:</strong> Current medications, allergies, doctor contacts provided</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-comms"> <label for="proxy-comms"><strong>Communication Plan:</strong> Check-in schedule established (minimum twice daily)</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-boundaries"> <label for="proxy-boundaries"><strong>Isolation Boundaries:</strong> Physical separation protocols clear</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="proxy-timesheet"> <label for="proxy-timesheet"><strong>Timesheet Entry:</strong> Dates recorded in Monthly Timesheet tab</label>
                    </div>
                </div>

                <h4 style="color: #e65100; margin-top: 20px;">Health & Safety Considerations</h4>
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #f39c12;">
                    <strong>Enhanced Hygiene Protocols:</strong>
                    <ul>
                        <li>Regular hand sanitization</li>
                        <li>Wendy must report any illness symptoms immediately</li>
                        <li>Must inform you of any exposure to infectious diseases within 24 hours</li>
                        <li>Strict protocols for maintaining physical separation during your isolation</li>
                    </ul>
                </div>

                <h4 style="color: #e65100; margin-top: 20px;">Common Scenarios</h4>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 4px solid #2196F3;">
                    <strong>Example 1: Your illness requiring 5-day isolation</strong>
                    <ul>
                        <li>Enter <strong>5</strong> in "Partial Days" field on Monthly Timesheet tab</li>
                        <li>Pay: 5 Ã Â£180.57 = Â£902.85</li>
                        <li>Paid with following month's salary</li>
                    </ul>
                    
                    <strong>Example 2: Emergency requiring full week</strong>
                    <ul>
                        <li>Enter <strong>1</strong> in "Proxy Parenting Periods" field</li>
                        <li>Pay: Â£1,264.00</li>
                        <li>Paid with following month's salary</li>
                    </ul>
                    
                    <strong>Example 3: Extended illness (10 days)</strong>
                    <ul>
                        <li>Enter <strong>1</strong> period + <strong>3</strong> partial days</li>
                        <li>Pay: Â£1,264 + (3 Ã Â£180.57) = Â£1,805.71</li>
                        <li>Paid with following month's salary</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard-grid">
                <div class="card">
                    <h3>This Year Summary</h3>
                    <div class="metric" id="ytdHours">0</div>
                    <p>Total Hours Worked</p>
                </div>
                <div class="card">
                    <h3>Total Earnings</h3>
                    <div class="metric" id="ytdEarnings">Â£0</div>
                    <p>Year to Date</p>
                </div>
                <div class="card">
                    <h3>Personal Holiday Balance</h3>
                    <div class="metric" id="holidayBalance">28</div>
                    <p>Days Remaining</p>
                </div>
                <div class="card">
                    <h3>TOIL Balance</h3>
                    <div class="metric" id="dashboardToilBalance">0</div>
                    <p>Hours Available</p>
                </div>
            </div>

            <div class="card">
                <h3>Recent Months Overview</h3>
                <table class="data-table" id="monthlyOverview">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Hours Worked</th>
                            <th>Personal Holiday</th>
                            <th>Family Holiday</th>
                            <th>Bank Holidays</th>
                            <th>Proxy Parenting</th>
                            <th>TOIL Balance</th>
                            <th>Gross Pay</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyOverviewBody">
                        <!-- Generated content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Annual Reports Tab -->
        <div id="annual" class="tab-content">
            <div class="card">
                <h3>Annual Summary Report</h3>
                <div style="margin-bottom: 20px;">
                    <label><strong>Year:</strong></label>
                    <select id="yearSelect" onchange="generateAnnualReport()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div id="annualReportContent">
                    <!-- Generated content -->
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="data" class="tab-content">
            <div class="card" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-left: 5px solid #2196F3; margin-bottom: 20px;">
                <h3 style="color: #1565c0; margin-top: 0;">System Test & Validation</h3>
                <p>Use this section to verify all calculations are working correctly.</p>
                <button class="btn btn-info" onclick="runSystemTest()">Run System Test</button>
                <div id="testResults" style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; display: none;"></div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-left: 5px solid #f39c12; margin-bottom: 20px;">
                <h3 style="color: #d35400; margin-top: 0;">Important: Regular Backups Required</h3>
                <p><strong>Browser storage is NOT reliable for critical payroll data.</strong> Chrome crashes, updates, or cache clearing can cause data loss.</p>
                <p><strong>Best Practice:</strong> Export a backup JSON file after every work session and store it safely.</p>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="exportAllData()" style="font-size: 16px; padding: 15px 30px;">Export Complete Backup Now</button>
                    <p style="font-size: 12px; margin-top: 10px;">Last save: <span id="lastSaveTime">Never</span></p>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Export Data</h3>
                    <button class="btn" onclick="exportAllData()">Export All Data (JSON)</button>
                    <button class="btn btn-info" onclick="exportAnnualCSV()">Export Annual CSV</button>
                    <button class="btn btn-secondary" onclick="generateCSV()">Export Current Month</button>
                    <p style="font-size: 12px; margin-top: 10px; color: #666;">JSON backup includes all months and settings</p>
                </div>
                <div class="card">
                    <h3>Import Data</h3>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn btn-info" onclick="importData()">Import Data</button>
                    <p style="font-size: 12px; margin-top: 10px; color: #666;">Restore from a previous JSON backup</p>
                </div>
                <div class="card">
                    <h3>Backup & Restore</h3>
                    <button class="btn btn-secondary" onclick="createBackup()">Create Backup</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                    <p style="font-size: 12px; margin-top: 10px; color: #666;">Clear all data removes everything permanently</p>
                </div>
            </div>
            
            <div class="card">
                <h3>Data Overview</h3>
                <div id="dataOverview">
                    <!-- Generated content -->
                </div>
            </div>
        </div>

        <div class="export-section">
            <button class="btn" onclick="generateCSV()">Export Current Month for Nannytax</button>
            <button class="btn btn-secondary" onclick="printTimesheet()">Print Current Month</button>
        </div>
    </div>

    <script>
        const HOURLY_RATE = 23.00;
        const CONTRACT_HOURS_PER_WEEK = 32;
        const ANNUAL_HOLIDAY_DAYS = 28;
        const PROXY_PARENTING_WEEKLY_RATE = 1264.00;
        const PROXY_PARENTING_DAILY_RATE = PROXY_PARENTING_WEEKLY_RATE / 7;

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = '<div class="status-message status-' + type + '">' + message + '</div>';
            setTimeout(function() {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'annual') {
                generateAnnualReport();
            } else if (tabName === 'data') {
                updateDataOverview();
            }
        }

        function getCurrentMonth() {
            return document.getElementById('monthSelect').value;
        }

        function countWorkingDaysInMonth(year, month) {
            let count = 0;
            const date = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            while (date <= lastDay) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) count++;
                date.setDate(date.getDate() + 1);
            }
            return count;
        }

        function calculateHolidayBalance() {
            const allData = getAllMonthlyData();
            let totalBankHolidays = 0;
            let totalPersonalHolidays = 0;
            let totalEmployerDirectedHolidays = 0;
            
            Object.keys(allData).forEach(function(month) {
                const data = allData[month];
                totalBankHolidays += data.bankHolidays || 0;
                totalPersonalHolidays += (data.personalHolidayHours || 0) / 8;
                totalEmployerDirectedHolidays += (data.employerDirectedHolidayHours || 0) / 8;
            });
            
            const totalHolidayUsed = totalBankHolidays + totalPersonalHolidays + totalEmployerDirectedHolidays;
            const remainingHolidays = ANNUAL_HOLIDAY_DAYS - totalHolidayUsed;
            
            return {
                totalUsed: totalHolidayUsed,
                bankHolidaysUsed: totalBankHolidays,
                personalHolidaysUsed: totalPersonalHolidays,
                employerDirectedUsed: totalEmployerDirectedHolidays,
                remaining: Math.max(0, remainingHolidays)
            };
        }

        function calculateToilBalance() {
            const allData = getAllMonthlyData();
            let currentBalance = 0;
            
            Object.keys(allData).sort().forEach(function(month) {
                const data = allData[month];
                currentBalance += (data.toilBalance || 0);
            });
            
            return Math.max(0, currentBalance);
        }

        function generateTimesheet() {
            const monthStr = getCurrentMonth();
            const parts = monthStr.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            const tbody = document.getElementById('timesheetBody');
            tbody.innerHTML = '';
            
            let weekNumber = 1;
            
            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-GB', { weekday: 'long' });
                const dayDate = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'numeric' });
                
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                
                const row = document.createElement('tr');
                if (isWeekend) {
                    row.style.backgroundColor = '#fff8dc';
                }
                row.innerHTML = '<td class="date-cell">' + (isWeekend ? '' : '') + dayName + ', ' + dayDate + '</td>' +
                    '<td><input type="time" class="time-input" id="timeIn_' + dateStr + '" onchange="calculateHours(\'' + dateStr + '\'); saveData();"></td>' +
                    '<td><input type="time" class="time-input" id="timeOut_' + dateStr + '" onchange="calculateHours(\'' + dateStr + '\'); saveData();"></td>' +
                    '<td class="hours-cell"><span id="hours_' + dateStr + '">0.00</span></td>' +
                    '<td class="personal-holiday-cell"><input type="number" class="time-input" id="personalHoliday_' + dateStr + '" min="0" max="8" step="0.25" placeholder="0" onchange="updateTotals(); saveData();" ' + (isWeekend ? 'disabled' : '') + '></td>' +
                    '<td class="family-holiday-cell"><input type="number" class="time-input" id="familyHoliday_' + dateStr + '" min="0" max="8" step="0.25" placeholder="0" onchange="updateTotals(); saveData();" style="width: 50px;" ' + (isWeekend ? 'disabled' : '') + '><br><input type="checkbox" id="toilToggle_' + dateStr + '" onchange="updateTotals(); saveData();" style="margin-top: 2px;" ' + (isWeekend ? 'disabled' : '') + '><label for="toilToggle_' + dateStr + '" style="font-size: 10px; margin-left: 2px;">TOIL</label></td>' +
                    '<td class="toil-usage-cell"><input type="number" class="time-input" id="toilUsage_' + dateStr + '" min="0" max="8" step="0.25" placeholder="0" onchange="updateTotals(); saveData();" ' + (isWeekend ? 'disabled' : '') + '></td>' +
                    '<td class="comments-cell"><input type="text" id="comments_' + dateStr + '" placeholder="' + (isWeekend ? 'Weekend overtime notes...' : 'Notes...') + '" style="width: 100%; border: none; background: transparent;" onchange="saveData();"></td>';
                tbody.appendChild(row);
                
                if (dayOfWeek === 5 || date.getTime() === lastDay.getTime()) {
                    const totalRow = document.createElement('tr');
                    totalRow.innerHTML = '<td class="week-total">Week ' + weekNumber + ' Total</td>' +
                        '<td class="week-total" colspan="2"></td>' +
                        '<td class="week-total"><span id="weekTotal_' + weekNumber + '">0.00</span></td>' +
                        '<td class="week-total"><span id="weekPersonalHoliday_' + weekNumber + '">0.00</span></td>' +
                        '<td class="week-total"><span id="weekFamilyHoliday_' + weekNumber + '">0.00</span></td>' +
                        '<td class="week-total"><span id="weekToilUsage_' + weekNumber + '">0.00</span></td>' +
                        '<td class="week-total"></td>';
                    tbody.appendChild(totalRow);
                    weekNumber++;
                }
            }
            
            loadSavedData();
            updateTotals();
        }

        function calculateHours(dateStr) {
            const timeInElement = document.getElementById('timeIn_' + dateStr);
            const timeOutElement = document.getElementById('timeOut_' + dateStr);
            
            if (!timeInElement || !timeOutElement) return;
            
            const timeIn = timeInElement.value;
            const timeOut = timeOutElement.value;
            
            if (timeIn && timeOut) {
                const startTime = new Date('2000-01-01T' + timeIn + ':00');
                const endTime = new Date('2000-01-01T' + timeOut + ':00');
                
                if (endTime < startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                
                const diffMs = endTime - startTime;
                const totalHours = diffMs / (1000 * 60 * 60);
                
                const hoursElement = document.getElementById('hours_' + dateStr);
                if (hoursElement) {
                    hoursElement.textContent = totalHours.toFixed(2);
                }
            } else {
                const hoursElement = document.getElementById('hours_' + dateStr);
                if (hoursElement) {
                    hoursElement.textContent = '0.00';
                }
            }
            
            updateTotals();
        }

        function updateTotals() {
            const monthStr = getCurrentMonth();
            const parts = monthStr.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            let totalWorkedHours = 0;
            let totalPersonalHolidayHours = 0;
            let totalFamilyHolidayHours = 0;
            let totalEmployerDirectedHolidayHours = 0;
            let totalToilUsageHours = 0;
            let totalToilCreatingHours = 0;
            let weekNumber = 1;
            let weekHours = 0;
            let weekPersonalHoliday = 0;
            let weekFamilyHoliday = 0;
            let weekToilUsage = 0;
            
            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                
                const hoursElement = document.getElementById('hours_' + dateStr);
                const personalHolidayElement = document.getElementById('personalHoliday_' + dateStr);
                const familyHolidayElement = document.getElementById('familyHoliday_' + dateStr);
                const toilUsageElement = document.getElementById('toilUsage_' + dateStr);
                const toilToggleElement = document.getElementById('toilToggle_' + dateStr);
                
                if (hoursElement && personalHolidayElement && familyHolidayElement && toilUsageElement) {
                    const dayHours = parseFloat(hoursElement.textContent) || 0;
                    const dayPersonalHoliday = parseFloat(personalHolidayElement.value) || 0;
                    const dayFamilyHoliday = parseFloat(familyHolidayElement.value) || 0;
                    const dayToilUsage = parseFloat(toilUsageElement.value) || 0;
                    const isToilCreating = toilToggleElement ? toilToggleElement.checked : false;
                    
                    totalWorkedHours += dayHours;
                    totalPersonalHolidayHours += dayPersonalHoliday;
                    totalFamilyHolidayHours += dayFamilyHoliday;
                    totalToilUsageHours += dayToilUsage;
                    weekHours += dayHours;
                    weekPersonalHoliday += dayPersonalHoliday;
                    weekFamilyHoliday += dayFamilyHoliday;
                    weekToilUsage += dayToilUsage;
                    
                    if (dayFamilyHoliday > 0) {
                        if (isToilCreating) {
                            totalToilCreatingHours += dayFamilyHoliday;
                        } else {
                            totalEmployerDirectedHolidayHours += dayFamilyHoliday;
                        }
                    }
                }
                
                if (dayOfWeek === 5 || date.getTime() === lastDay.getTime()) {
                    const weekTotalEl = document.getElementById('weekTotal_' + weekNumber);
                    const weekPersonalHolidayEl = document.getElementById('weekPersonalHoliday_' + weekNumber);
                    const weekFamilyHolidayEl = document.getElementById('weekFamilyHoliday_' + weekNumber);
                    const weekToilUsageEl = document.getElementById('weekToilUsage_' + weekNumber);
                    
                    if (weekTotalEl) weekTotalEl.textContent = weekHours.toFixed(2);
                    if (weekPersonalHolidayEl) weekPersonalHolidayEl.textContent = weekPersonalHoliday.toFixed(2);
                    if (weekFamilyHolidayEl) weekFamilyHolidayEl.textContent = weekFamilyHoliday.toFixed(2);
                    if (weekToilUsageEl) weekToilUsageEl.textContent = weekToilUsage.toFixed(2);
                    
                    weekNumber++;
                    weekHours = 0;
                    weekPersonalHoliday = 0;
                    weekFamilyHoliday = 0;
                    weekToilUsage = 0;
                }
            }
            
            const toilFromPreviousElement = document.getElementById('toilFromPrevious');
            const familyHolidayDaysElement = document.getElementById('familyHolidayDays');
            const currentBankHolidaysElement = document.getElementById('currentBankHolidays');
            const proxyParentingPeriodsElement = document.getElementById('proxyParentingPeriods');
            const proxyParentingDaysElement = document.getElementById('proxyParentingDays');
            
            const toilFromPrevious = toilFromPreviousElement ? parseFloat(toilFromPreviousElement.value) || 0 : 0;
            const familyHolidayDays = familyHolidayDaysElement ? parseFloat(familyHolidayDaysElement.value) || 0 : 0;
            const currentBankHolidays = currentBankHolidaysElement ? parseFloat(currentBankHolidaysElement.value) || 0 : 0;
            const proxyParentingPeriods = proxyParentingPeriodsElement ? parseFloat(proxyParentingPeriodsElement.value) || 0 : 0;
            const proxyParentingDays = proxyParentingDaysElement ? parseFloat(proxyParentingDaysElement.value) || 0 : 0;
            
            const proxyParentingPay = (proxyParentingPeriods * PROXY_PARENTING_WEEKLY_RATE) + (proxyParentingDays * PROXY_PARENTING_DAILY_RATE);
            
            const totalFamilyHolidayFromDays = familyHolidayDays * 6.4;
            const combinedToilCreatingHours = totalToilCreatingHours + totalFamilyHolidayFromDays;
            
            const workingDaysInCurrentMonth = countWorkingDaysInMonth(year, month - 1);
            const contractHours = (workingDaysInCurrentMonth / 5) * CONTRACT_HOURS_PER_WEEK;
            const overtimeHours = Math.max(0, totalWorkedHours - contractHours);
            
            const currentToilDebt = toilFromPrevious + combinedToilCreatingHours;
            const toilOffsetByOvertime = Math.min(overtimeHours, currentToilDebt);
            const remainingOvertimeAfterToilOffset = overtimeHours - toilOffsetByOvertime;
            const remainingToilDebt = Math.max(0, currentToilDebt - toilOffsetByOvertime);
            const netToilBalance = remainingToilDebt - totalToilUsageHours;
            
            const totalPay = (totalWorkedHours + totalPersonalHolidayHours + totalEmployerDirectedHolidayHours + totalToilUsageHours) * HOURLY_RATE + proxyParentingPay;
            
            const holidayBalance = calculateHolidayBalance();
            const personalHolidaysThisMonth = totalPersonalHolidayHours / 8;
            const employerDirectedThisMonth = totalEmployerDirectedHolidayHours / 8;
            
            const updateElement = function(id, value) {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };
            
            updateElement('totalHours', totalWorkedHours.toFixed(2));
            updateElement('contractHours', contractHours.toFixed(2));
            updateElement('overtimeHours', overtimeHours.toFixed(2));
            updateElement('toilOffset', toilOffsetByOvertime.toFixed(2));
            updateElement('remainingOvertime', remainingOvertimeAfterToilOffset.toFixed(2));
            updateElement('netPersonalHolidayHours', totalPersonalHolidayHours.toFixed(2));
            updateElement('totalPay', totalPay.toFixed(2));
            updateElement('proxyParentingPay', proxyParentingPay.toFixed(2));
            
            updateElement('toilUsedThisMonth', totalToilUsageHours.toFixed(2));
            updateElement('toilToCarryForward', netToilBalance.toFixed(2));
            updateElement('toilBalance', netToilBalance.toFixed(2));
            
            updateElement('personalHolidaysThisMonth', personalHolidaysThisMonth.toFixed(2));
            updateElement('employerDirectedThisMonth', employerDirectedThisMonth.toFixed(2));
            updateElement('bankHolidaysUsed', holidayBalance.bankHolidaysUsed.toFixed(1));
            updateElement('personalHolidaysUsed', holidayBalance.personalHolidaysUsed.toFixed(1));
            updateElement('employerDirectedUsed', holidayBalance.employerDirectedUsed.toFixed(1));
            updateElement('totalHolidaysUsed', holidayBalance.totalUsed.toFixed(1));
            updateElement('personalHolidaysRemaining', holidayBalance.remaining.toFixed(0));
            updateElement('remainingHolidays', holidayBalance.remaining.toFixed(1));
            updateElement('holidaysTotal', ANNUAL_HOLIDAY_DAYS.toString());
            
            updateElement('submissionHours', totalWorkedHours.toFixed(2));
            updateElement('submissionPay', (totalWorkedHours * HOURLY_RATE).toFixed(2));
            updateElement('submissionHolidayPay', ((totalPersonalHolidayHours + totalEmployerDirectedHolidayHours + totalToilUsageHours) * HOURLY_RATE).toFixed(2));
            updateElement('submissionOvertimePay', (remainingOvertimeAfterToilOffset * HOURLY_RATE).toFixed(2));
            updateElement('submissionProxyPay', proxyParentingPay.toFixed(2));
            updateElement('submissionTotal', totalPay.toFixed(2));
            
            saveMonthlyData(monthStr, {
                workedHours: totalWorkedHours,
                personalHolidayHours: totalPersonalHolidayHours,
                employerDirectedHolidayHours: totalEmployerDirectedHolidayHours,
                familyHolidayHours: totalFamilyHolidayHours,
                toilCreatingHours: combinedToilCreatingHours,
                toilUsageHours: totalToilUsageHours,
                bankHolidays: currentBankHolidays,
                toilBalance: netToilBalance,
                overtimeHours: overtimeHours,
                proxyParentingPay: proxyParentingPay,
                proxyParentingPeriods: proxyParentingPeriods,
                proxyParentingDays: proxyParentingDays,
                grossPay: totalPay
            });
        }

        function saveData() {
            const monthStr = getCurrentMonth();
            const data = {};
            
            const inputs = document.querySelectorAll('input[type="time"], input[type="number"], input[type="text"], input[type="month"], input[type="checkbox"]');
            inputs.forEach(function(input) {
                if (input.type === 'checkbox') {
                    data[input.id] = input.checked;
                } else if (input.value !== '' && input.id) {
                    data[input.id] = input.value;
                }
                if (input.id === 'toilFromPrevious' || input.id === 'familyHolidayDays' || input.id === 'currentBankHolidays' || input.id === 'proxyParentingPeriods' || input.id === 'proxyParentingDays') {
                    data[input.id] = input.value || '0';
                }
            });
            
            localStorage.setItem('timesheet_' + monthStr, JSON.stringify(data));
            localStorage.setItem('last_save_time', new Date().toISOString());
            
            const verification = localStorage.getItem('timesheet_' + monthStr);
            if (verification) {
                showStatus('Data saved successfully! (' + Object.keys(data).length + ' fields) - Backup recommended', 'success');
                
                const saveCount = parseInt(localStorage.getItem('save_count') || '0') + 1;
                localStorage.setItem('save_count', saveCount.toString());
                
                if (saveCount % 5 === 0) {
                    setTimeout(function() {
                        if (confirm('You have made ' + saveCount + ' saves. Would you like to download a backup now?')) {
                            exportAllData();
                        }
                    }, 1000);
                }
            } else {
                showStatus('WARNING: Data may not have saved properly! Export backup immediately.', 'error');
            }
        }

        function loadSavedData() {
            const monthStr = getCurrentMonth();
            const savedData = localStorage.getItem('timesheet_' + monthStr);
            
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.keys(data).forEach(function(id) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = data[id] === true;
                        } else {
                            element.value = data[id];
                        }
                        if (id.indexOf('timeIn_') !== -1 || id.indexOf('timeOut_') !== -1) {
                            const dateStr = id.split('_')[1];
                            calculateHours(dateStr);
                        }
                    }
                });
            }
        }

        function saveMonthlyData(month, summary) {
            const existingData = JSON.parse(localStorage.getItem('monthly_summaries') || '{}');
            existingData[month] = summary;
            localStorage.setItem('monthly_summaries', JSON.stringify(existingData));
        }

        function getAllMonthlyData() {
            return JSON.parse(localStorage.getItem('monthly_summaries') || '{}');
        }

        function updateDashboard() {
            const allData = getAllMonthlyData();
            const currentYear = new Date().getFullYear();
            
            let ytdHours = 0;
            let ytdEarnings = 0;
            
            Object.keys(allData).forEach(function(month) {
                const parts = month.split('-');
                const year = parseInt(parts[0]);
                if (year === currentYear) {
                    const data = allData[month];
                    ytdHours += data.workedHours || 0;
                    ytdEarnings += data.grossPay || 0;
                }
            });
            
            const holidayBalance = calculateHolidayBalance();
            const toilBalance = calculateToilBalance();
            
            document.getElementById('ytdHours').textContent = ytdHours.toFixed(0);
            document.getElementById('ytdEarnings').textContent = 'Â£' + ytdEarnings.toFixed(0);
            document.getElementById('holidayBalance').textContent = holidayBalance.remaining.toFixed(0);
            document.getElementById('dashboardToilBalance').textContent = toilBalance.toFixed(0);
            
            const tbody = document.getElementById('monthlyOverviewBody');
            tbody.innerHTML = '';
            
            const sortedMonths = Object.keys(allData).sort().reverse().slice(0, 12);
            if (sortedMonths.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No data available yet. Start entering timesheet data to see summaries.</td></tr>';
                return;
            }
            
            sortedMonths.forEach(function(month) {
                const data = allData[month];
                const row = document.createElement('tr');
                const monthName = new Date(month + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                
                row.innerHTML = '<td><a href="javascript:void(0)" onclick="switchToMonth(\'' + month + '\')" style="color: #4CAF50; text-decoration: none; font-weight: bold;">' + monthName + '</a></td>' +
                    '<td>' + (data.workedHours || 0).toFixed(2) + '</td>' +
                    '<td>' + ((data.personalHolidayHours || 0) / 8).toFixed(2) + '</td>' +
                    '<td>' + ((data.familyHolidayHours || 0) / 8).toFixed(2) + '</td>' +
                    '<td>' + (data.bankHolidays || 0).toFixed(1) + '</td>' +
                    '<td>' + (data.proxyParentingPay ? 'Â£' + data.proxyParentingPay.toFixed(0) : '-') + '</td>' +
                    '<td>' + (data.toilBalance || 0).toFixed(1) + '</td>' +
                    '<td>Â£' + (data.grossPay || 0).toFixed(2) + '</td>';
                row.style.cursor = 'pointer';
                tbody.appendChild(row);
            });
        }

        function generateAnnualReport() {
            const year = document.getElementById('yearSelect').value;
            const allData = getAllMonthlyData();
            const reportContent = document.getElementById('annualReportContent');
            
            let annualHours = 0;
            let annualEarnings = 0;
            let annualPersonalHolidayHours = 0;
            let annualFamilyHolidayHours = 0;
            let annualBankHolidays = 0;
            let annualOvertimeHours = 0;
            let annualProxyParentingPay = 0;
            let finalToilBalance = 0;
            let monthsWorked = 0;
            
            const monthlyData = [];
            
            for (let month = 1; month <= 12; month++) {
                const monthKey = year + '-' + String(month).padStart(2, '0');
                const data = allData[monthKey];
                
                if (data) {
                    annualHours += data.workedHours || 0;
                    annualEarnings += data.grossPay || 0;
                    annualPersonalHolidayHours += data.personalHolidayHours || 0;
                    annualFamilyHolidayHours += data.familyHolidayHours || 0;
                    annualBankHolidays += data.bankHolidays || 0;
                    annualOvertimeHours += data.overtimeHours || 0;
                    annualProxyParentingPay += data.proxyParentingPay || 0;
                    finalToilBalance = data.toilBalance || 0;
                    monthsWorked++;
                    
                    monthlyData.push({
                        month: new Date(monthKey + '-01').toLocaleDateString('en-GB', { month: 'long' }),
                        ...data
                    });
                }
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">';
            html += '<div class="card"><h4>Total Hours</h4><div class="metric" style="font-size: 1.5em;">' + annualHours.toFixed(0) + '</div></div>';
            html += '<div class="card"><h4>Total Earnings</h4><div class="metric" style="font-size: 1.5em;">Â£' + annualEarnings.toFixed(0) + '</div></div>';
            html += '<div class="card"><h4>Personal Holiday</h4><div class="metric" style="font-size: 1.5em;">' + (annualPersonalHolidayHours / 8).toFixed(1) + '</div><p>Days</p></div>';
            html += '<div class="card"><h4>Family Holiday</h4><div class="metric" style="font-size: 1.5em;">' + (annualFamilyHolidayHours / 8).toFixed(1) + '</div><p>Days</p></div>';
            html += '<div class="card"><h4>Bank Holidays</h4><div class="metric" style="font-size: 1.5em;">' + annualBankHolidays.toFixed(1) + '</div><p>Days</p></div>';
            html += '<div class="card"><h4>Proxy Parenting</h4><div class="metric" style="font-size: 1.5em;">Â£' + annualProxyParentingPay.toFixed(0) + '</div></div>';
            html += '<div class="card"><h4>TOIL Balance</h4><div class="metric" style="font-size: 1.5em;">' + finalToilBalance.toFixed(1) + '</div><p>Hours</p></div>';
            html += '</div>';
            
            if (monthlyData.length > 0) {
                html += '<table class="data-table">';
                html += '<thead><tr><th>Month</th><th>Hours</th><th>Personal Holiday</th><th>Family Holiday</th><th>Bank Holidays</th><th>Proxy Parenting</th><th>TOIL Balance</th><th>Gross Pay</th></tr></thead><tbody>';
                
                monthlyData.forEach(function(month) {
                    html += '<tr>';
                    html += '<td>' + month.month + '</td>';
                    html += '<td>' + (month.workedHours || 0).toFixed(2) + '</td>';
                    html += '<td>' + ((month.personalHolidayHours || 0) / 8).toFixed(2) + '</td>';
                    html += '<td>' + ((month.familyHolidayHours || 0) / 8).toFixed(2) + '</td>';
                    html += '<td>' + (month.bankHolidays || 0).toFixed(1) + '</td>';
                    html += '<td>' + (month.proxyParentingPay ? 'Â£' + month.proxyParentingPay.toFixed(0) : '-') + '</td>';
                    html += '<td>' + (month.toilBalance || 0).toFixed(1) + '</td>';
                    html += '<td>Â£' + (month.grossPay || 0).toFixed(2) + '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            } else {
                html += '<p>No data available for ' + year + '</p>';
            }
            
            reportContent.innerHTML = html;
        }

        function updateDataOverview() {
            const allData = getAllMonthlyData();
            const overview = document.getElementById('dataOverview');
            
            let html = '<h4>Stored Data Overview</h4>';
            html += '<p>Total months with data: ' + Object.keys(allData).length + '</p>';
            
            const holidayBalance = calculateHolidayBalance();
            const toilBalance = calculateToilBalance();
            
            html += '<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">';
            html += '<strong>Current Balances:</strong><br>';
            html += 'Personal Holiday Remaining: ' + holidayBalance.remaining.toFixed(1) + ' days<br>';
            html += 'TOIL Balance: ' + toilBalance.toFixed(1) + ' hours<br>';
            html += 'Bank Holidays Used: ' + holidayBalance.bankHolidaysUsed.toFixed(1) + ' days<br>';
            html += 'Personal Holiday Used: ' + holidayBalance.personalHolidaysUsed.toFixed(1) + ' days';
            html += '</div>';
            
            if (Object.keys(allData).length > 0) {
                html += '<table class="data-table">';
                html += '<thead><tr><th>Month</th><th>Hours</th><th>Personal Holiday</th><th>Family Holiday</th><th>Proxy Parenting</th><th>TOIL Balance</th><th>Earnings</th></tr></thead><tbody>';
                
                Object.keys(allData).sort().reverse().forEach(function(month) {
                    const data = allData[month];
                    const monthName = new Date(month + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    
                    html += '<tr>';
                    html += '<td>' + monthName + '</td>';
                    html += '<td>' + (data.workedHours || 0).toFixed(2) + '</td>';
                    html += '<td>' + ((data.personalHolidayHours || 0) / 8).toFixed(2) + '</td>';
                    html += '<td>' + ((data.familyHolidayHours || 0) / 8).toFixed(2) + '</td>';
                    html += '<td>' + (data.proxyParentingPay ? 'Â£' + data.proxyParentingPay.toFixed(0) : '-') + '</td>';
                    html += '<td>' + (data.toilBalance || 0).toFixed(1) + '</td>';
                    html += '<td>Â£' + (data.grossPay || 0).toFixed(2) + '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            } else {
                html += '<p>No monthly summaries available. Enter timesheet data to see summaries.</p>';
            }
            
            overview.innerHTML = html;
        }

        function runSystemTest() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.style.display = 'block';
            let html = '<h4>System Test Results:</h4><ul style="list-style: none; padding: 0;">';
            
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                html += '<li>â <strong>localStorage:</strong> Working correctly</li>';
            } catch (e) {
                html += '<li>â <strong>localStorage:</strong> NOT working - ' + e.message + '</li>';
            }
            
            const currentMonth = getCurrentMonth();
            const savedData = localStorage.getItem('timesheet_' + currentMonth);
            if (savedData) {
                const dataSize = savedData.length;
                html += '<li>â <strong>Current month data:</strong> ' + dataSize + ' characters stored</li>';
            } else {
                html += '<li>â ï¸ <strong>Current month data:</strong> No data saved yet</li>';
            }
            
            const holidayBalance = calculateHolidayBalance();
            html += '<li>â <strong>Holiday balance:</strong> ' + holidayBalance.remaining.toFixed(1) + ' days remaining</li>';
            html += '<li style="margin-left: 20px;">- Bank holidays used: ' + holidayBalance.bankHolidaysUsed.toFixed(1) + ' days</li>';
            html += '<li style="margin-left: 20px;">- Personal holidays used: ' + holidayBalance.personalHolidaysUsed.toFixed(1) + ' days</li>';
            html += '<li style="margin-left: 20px;">- Employer-directed used: ' + holidayBalance.employerDirectedUsed.toFixed(1) + ' days</li>';
            
            const toilBalance = calculateToilBalance();
            html += '<li>â <strong>TOIL balance:</strong> ' + toilBalance.toFixed(1) + ' hours</li>';
            
            const allData = getAllMonthlyData();
            const monthCount = Object.keys(allData).length;
            html += '<li>â <strong>Monthly summaries:</strong> ' + monthCount + ' month(s) stored</li>';
            
            html += '<li>â <strong>Weekend tracking:</strong> Enabled (all hours count as overtime)</li>';
            html += '<li>â <strong>Proxy parenting:</strong> Tracking enabled</li>';
            
            const totalHoursEl = document.getElementById('totalHours');
            if (totalHoursEl) {
                const totalHours = parseFloat(totalHoursEl.textContent) || 0;
                if (totalHours > 200) {
                    html += '<li>â ï¸ <strong>Validation warning:</strong> Total hours (' + totalHours + ') seems unusually high</li>';
                } else {
                    html += '<li>â <strong>Hours validation:</strong> Total hours within normal range</li>';
                }
            }
            
            html += '</ul>';
            html += '<p style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px;"><strong>Test completed at:</strong> ' + new Date().toLocaleString('en-GB') + '</p>';
            resultsDiv.innerHTML = html;
        }

        function exportAllData() {
            const allTimesheet = {};
            const allSummaries = getAllMonthlyData();
            
            for (let key in localStorage) {
                if (key.startsWith('timesheet_')) {
                    allTimesheet[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            
            const exportData = {
                timesheets: allTimesheet,
                summaries: allSummaries,
                exportDate: new Date().toISOString(),
                version: '6.0-ProxyParenting'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Wendy_Ballard_Complete_Data_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(link.href);
            
            showStatus('All data exported successfully!', 'success');
        }

        function exportAnnualCSV() {
            const year = prompt('Enter year to export (e.g., 2025):');
            if (!year) return;
            
            const allData = getAllMonthlyData();
            let csv = 'Month,Hours Worked,Personal Holiday Hours,Personal Holiday Days,Family Holiday Hours,Family Holiday Days,Bank Holiday Days,Proxy Parenting Pay,TOIL Balance,Overtime Hours,Gross Pay\n';
            
            for (let month = 1; month <= 12; month++) {
                const monthKey = year + '-' + String(month).padStart(2, '0');
                const data = allData[monthKey];
                
                if (data) {
                    const monthName = new Date(monthKey + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    csv += monthName + ',' + 
                           (data.workedHours || 0).toFixed(2) + ',' + 
                           (data.personalHolidayHours || 0).toFixed(2) + ',' + 
                           ((data.personalHolidayHours || 0) / 8).toFixed(2) + ',' + 
                           (data.familyHolidayHours || 0).toFixed(2) + ',' + 
                           ((data.familyHolidayHours || 0) / 8).toFixed(2) + ',' + 
                           (data.bankHolidays || 0).toFixed(1) + ',' + 
                           (data.proxyParentingPay || 0).toFixed(2) + ',' + 
                           (data.toilBalance || 0).toFixed(2) + ',' + 
                           (data.overtimeHours || 0).toFixed(2) + ',' + 
                           (data.grossPay || 0).toFixed(2) + '\n';
                }
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Wendy_Ballard_Annual_' + year + '.csv';
            link.click();
            URL.revokeObjectURL(link);
            
            showStatus('Annual CSV exported successfully!', 'success');
        }

        function generateCSV() {
            const monthStr = getCurrentMonth();
            const parts = monthStr.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const monthName = new Date(year, month - 1).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            
            let csv = 'Date,Day,Time In,Time Out,Hours Worked,Personal Holiday,Family Holiday,TOIL Usage,Comments\n';
            
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-GB', { weekday: 'long' });
                const dateFormat = date.toLocaleDateString('en-GB');
                
                const timeInElement = document.getElementById('timeIn_' + dateStr);
                const timeOutElement = document.getElementById('timeOut_' + dateStr);
                const hoursElement = document.getElementById('hours_' + dateStr);
                const personalHolidayElement = document.getElementById('personalHoliday_' + dateStr);
                const familyHolidayElement = document.getElementById('familyHoliday_' + dateStr);
                const toilUsageElement = document.getElementById('toilUsage_' + dateStr);
                const commentsElement = document.getElementById('comments_' + dateStr);
                
                const timeIn = timeInElement ? timeInElement.value : '';
                const timeOut = timeOutElement ? timeOutElement.value : '';
                const hours = hoursElement ? hoursElement.textContent : '0.00';
                const personalHoliday = personalHolidayElement ? personalHolidayElement.value : '';
                const familyHoliday = familyHolidayElement ? familyHolidayElement.value : '';
                const toilUsage = toilUsageElement ? toilUsageElement.value : '';
                const comments = commentsElement ? commentsElement.value.replace(/"/g, '""') : '';
                
                csv += dateFormat + ',' + dayName + ',' + timeIn + ',' + timeOut + ',' + hours + ',' + personalHoliday + ',' + familyHoliday + ',' + toilUsage + ',"' + comments + '"\n';
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = 'Wendy_Ballard_Timesheet_' + monthName.replace(' ', '_') + '.csv';
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showStatus('Monthly CSV exported successfully!', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a file to import', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.timesheets) {
                        Object.keys(data.timesheets).forEach(function(key) {
                            localStorage.setItem(key, JSON.stringify(data.timesheets[key]));
                        });
                    }
                    
                    if (data.summaries) {
                        localStorage.setItem('monthly_summaries', JSON.stringify(data.summaries));
                    }
                    
                    showStatus('Data imported successfully!', 'success');
                    generateTimesheet();
                    updateDashboard();
                } catch (error) {
                    showStatus('Error importing data: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function createBackup() {
            exportAllData();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                if (confirm('This will delete all timesheets and summaries. Are you absolutely sure?')) {
                    for (let key in localStorage) {
                        if (key.startsWith('timesheet_') || key === 'monthly_summaries') {
                            localStorage.removeItem(key);
                        }
                    }
                    showStatus('All data cleared!', 'success');
                    generateTimesheet();
                    updateDashboard();
                }
            }
        }

        function printTimesheet() {
            window.print();
        }

        function switchToMonth(monthStr) {
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) {
                monthSelect.value = monthStr;
            }
            
            showTab('monthly');
            generateTimesheet();
            
            const monthName = new Date(monthStr + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            showStatus('Switched to ' + monthName + ' timesheet', 'success');
        }

        window.onload = function() {
            generateTimesheet();
            
            const lastSave = localStorage.getItem('last_save_time');
            if (lastSave) {
                const saveDate = new Date(lastSave);
                const timeAgo = Math.floor((new Date() - saveDate) / 60000);
                const lastSaveElement = document.getElementById('lastSaveTime');
                if (lastSaveElement) {
                    if (timeAgo < 1) {
                        lastSaveElement.textContent = 'Just now';
                    } else if (timeAgo < 60) {
                        lastSaveElement.textContent = timeAgo + ' minutes ago';
                    } else if (timeAgo < 1440) {
                        lastSaveElement.textContent = Math.floor(timeAgo / 60) + ' hours ago';
                    } else {
                        lastSaveElement.textContent = saveDate.toLocaleDateString('en-GB') + ' at ' + saveDate.toLocaleTimeString('en-GB');
                    }
                }
            }
        };
    </script>
</body>
</html>
