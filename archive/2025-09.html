<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanny Timesheet Management System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #4CAF50;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.2em;
        }
        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }
        .nav-tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            background: #4CAF50;
            color: white;
        }
        .nav-tab:hover {
            background: #45a049;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }
        .info-box {
            text-align: center;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        .info-box .value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .timesheet-table th,
        .timesheet-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .timesheet-table th {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            font-weight: 600;
        }
        .date-cell {
            text-align: left;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .time-input {
            width: 80px;
            border: none;
            background: transparent;
            text-align: center;
            font-family: inherit;
        }
        .hours-cell {
            background-color: #e8f5e8;
            font-weight: bold;
        }
        .holiday-cell {
            background-color: #fff3cd;
        }
        .week-total {
            background-color: #d1ecf1;
            font-weight: bold;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }
        .card h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        .metric {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        .carry-forward-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196F3;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        .data-table th {
            background: #343a40;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }
        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        .export-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        @media print {
            .nav-tabs, .export-section, .btn { display: none !important; }
            body { font-size: 12px; }
        }
        @media (max-width: 768px) {
            .info-section { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Nanny Timesheet Management System</h1>
            <p>Wendy Ballard - Professional Time Tracking & Payroll Management</p>
        </div>

        <div id="statusMessage"></div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('monthly')">Monthly Timesheet</button>
            <button class="nav-tab" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('annual')">Annual Reports</button>
            <button class="nav-tab" onclick="showTab('data')">Data Management</button>
        </div>

        <!-- Monthly Timesheet Tab -->
        <div id="monthly" class="tab-content active">
            <div class="info-section">
                <div class="info-box">
                    <h3>Current Month</h3>
                    <div class="value">
                        <input type="month" id="monthSelect" value="2025-09" onchange="generateTimesheet()" style="background: transparent; border: none; color: white; font-size: 0.8em;">
                    </div>
                    <div>£23.00/hour | 32h/week contract</div>
                </div>
                <div class="info-box">
                    <h3>Holiday Balance</h3>
                    <div class="value"><span id="holidaysRemaining">27</span>/28</div>
                    <div>Days remaining this year</div>
                </div>
                <div class="info-box">
                    <h3>Carried Forward</h3>
                    <div class="value">
                        <input type="number" id="carriedForwardHours" value="0" step="0.25" onchange="updateTotals()" style="width: 80px; background: transparent; border: 1px solid white; color: white; text-align: center; border-radius: 4px;">
                    </div>
                    <div>Hours from previous month</div>
                </div>
            </div>

            <table class="timesheet-table" id="timesheetTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time In</th>
                        <th>Time Out</th>
                        <th>Hours</th>
                        <th>Holiday</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="timesheetBody">
                    <!-- Generated content -->
                </tbody>
            </table>

            <div class="carry-forward-section">
                <h3 style="margin-top: 0; color: #1976d2;">Cross-Month Holiday Management</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Hours Worked:</strong> <span id="totalHours">0.00</span><br>
                        <strong>Overtime Hours:</strong> <span id="overtimeHours">0.00</span><br>
                        <strong>Holiday Hours:</strong> <span id="currentHolidayHours">0.00</span>
                    </div>
                    <div>
                        <strong>Carried Forward In:</strong> <span id="displayCarriedForward">0.00</span><br>
                        <strong>Holiday Offset Applied:</strong> <span id="holidayOffset">0.00</span><br>
                        <strong>Net Holiday Pay:</strong> <span id="netHolidayHours">0.00</span>
                    </div>
                    <div>
                        <strong>Manual Override:</strong> 
                        <input type="number" id="manualCarryForward" step="0.25" style="width: 60px;" placeholder="0" onchange="updateTotals()"><br>
                        <strong>Carry Forward Out:</strong> <span id="carryForwardNext">0.00</span><br>
                        <strong>Final Overtime:</strong> <span id="finalOvertime">0.00</span>
                    </div>
                    <div>
                        <strong>Total Gross Pay:</strong><br>
                        <span style="font-size: 1.5em; color: #2c3e50;">£<span id="totalPay">0.00</span></span><br>
                        <small>Working hours + Net holiday pay</small>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>For Nannytax Submission</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>Hours Worked:</strong> <span id="submissionHours">0.00</span></div>
                    <div><strong>Gross Pay:</strong> £<span id="submissionPay">0.00</span></div>
                    <div><strong>Holiday Pay:</strong> £<span id="submissionHolidayPay">0.00</span></div>
                    <div><strong>Total Gross:</strong> £<span id="submissionTotal">0.00</span></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard-grid">
                <div class="card">
                    <h3>This Year Summary</h3>
                    <div class="metric" id="ytdHours">0</div>
                    <p>Total Hours Worked</p>
                </div>
                <div class="card">
                    <h3>Total Earnings</h3>
                    <div class="metric" id="ytdEarnings">£0</div>
                    <p>Year to Date</p>
                </div>
                <div class="card">
                    <h3>Holiday Balance</h3>
                    <div class="metric" id="holidayBalance">27</div>
                    <p>Days Remaining</p>
                </div>
                <div class="card">
                    <h3>Average Weekly</h3>
                    <div class="metric" id="avgWeekly">0</div>
                    <p>Hours per Week</p>
                </div>
            </div>

            <div class="card">
                <h3>Recent Months Overview</h3>
                <table class="data-table" id="monthlyOverview">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Hours Worked</th>
                            <th>Holiday Hours</th>
                            <th>Overtime</th>
                            <th>Gross Pay</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyOverviewBody">
                        <!-- Generated content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Annual Reports Tab -->
        <div id="annual" class="tab-content">
            <div class="card">
                <h3>Annual Summary Report</h3>
                <div style="margin-bottom: 20px;">
                    <label><strong>Year:</strong></label>
                    <select id="yearSelect" onchange="generateAnnualReport()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div id="annualReportContent">
                    <!-- Generated content -->
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="data" class="tab-content">
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Export Data</h3>
                    <button class="btn" onclick="exportAllData()">Export All Data (JSON)</button>
                    <button class="btn btn-info" onclick="exportAnnualCSV()">Export Annual CSV</button>
                    <button class="btn btn-secondary" onclick="generateCSV()">Export Current Month</button>
                </div>
                <div class="card">
                    <h3>Import Data</h3>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn btn-info" onclick="importData()">Import Data</button>
                </div>
                <div class="card">
                    <h3>Backup & Restore</h3>
                    <button class="btn btn-secondary" onclick="createBackup()">Create Backup</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
            
            <div class="card">
                <h3>Data Overview</h3>
                <div id="dataOverview">
                    <!-- Generated content -->
                </div>
            </div>
        </div>

        <div class="export-section">
            <button class="btn" onclick="generateCSV()">Export Current Month for Nannytax</button>
            <button class="btn btn-secondary" onclick="printTimesheet()">Print Current Month</button>
        </div>
    </div>

    <script>
        const HOURLY_RATE = 23.00;
        const CONTRACT_HOURS_PER_WEEK = 32;
        const ANNUAL_HOLIDAY_DAYS = 28;

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'annual') {
                generateAnnualReport();
            } else if (tabName === 'data') {
                updateDataOverview();
            }
        }

        function getCurrentMonth() {
            return document.getElementById('monthSelect').value;
        }

        function countWorkingDaysInMonth(year, month) {
            let count = 0;
            const date = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            while (date <= lastDay) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) count++;
                date.setDate(date.getDate() + 1);
            }
            return count;
        }

        function generateTimesheet() {
            const monthStr = getCurrentMonth();
            const [year, month] = monthStr.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            const carriedForwardInput = document.getElementById('carriedForwardHours');
            if (year === 2025 && month === 10) {
                carriedForwardInput.value = '48';
            } else {
                carriedForwardInput.value = '0';
            }
            
            const tbody = document.getElementById('timesheetBody');
            tbody.innerHTML = '';
            
            let weekNumber = 1;
            
            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-GB', { weekday: 'long' });
                const dayDate = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'numeric' });
                
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                
                const row = document.createElement('tr');
                row.innerHTML = '<td class="date-cell">' + dayName + ', ' + dayDate + '</td>' +
                    '<td><input type="time" class="time-input" id="timeIn_' + dateStr + '" onchange="calculateHours(\'' + dateStr + '\')"></td>' +
                    '<td><input type="time" class="time-input" id="timeOut_' + dateStr + '" onchange="calculateHours(\'' + dateStr + '\')"></td>' +
                    '<td class="hours-cell"><span id="hours_' + dateStr + '">0.00</span></td>' +
                    '<td class="holiday-cell"><input type="number" class="time-input" id="holiday_' + dateStr + '" min="0" max="8" step="0.25" placeholder="0" onchange="updateTotals()"></td>' +
                    '<td class="comments-cell"><input type="text" id="comments_' + dateStr + '" placeholder="Notes..." style="width: 100%; border: none; background: transparent;" onchange="saveData()"></td>';
                tbody.appendChild(row);
                
                if (dayOfWeek === 5 || date.getTime() === lastDay.getTime()) {
                    const totalRow = document.createElement('tr');
                    totalRow.innerHTML = '<td class="week-total">Week ' + weekNumber + ' Total</td>' +
                        '<td class="week-total" colspan="2"></td>' +
                        '<td class="week-total"><span id="weekTotal_' + weekNumber + '">0.00</span></td>' +
                        '<td class="week-total"><span id="weekHoliday_' + weekNumber + '">0.00</span></td>' +
                        '<td class="week-total"></td>';
                    tbody.appendChild(totalRow);
                    weekNumber++;
                }
            }
            
            loadSavedData();
            updateTotals();
        }

        function calculateHours(dateStr) {
            const timeIn = document.getElementById('timeIn_' + dateStr).value;
            const timeOut = document.getElementById('timeOut_' + dateStr).value;
            
            if (timeIn && timeOut) {
                const startTime = new Date('2000-01-01T' + timeIn + ':00');
                const endTime = new Date('2000-01-01T' + timeOut + ':00');
                
                if (endTime < startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                
                const diffMs = endTime - startTime;
                const totalHours = diffMs / (1000 * 60 * 60);
                
                document.getElementById('hours_' + dateStr).textContent = totalHours.toFixed(2);
            } else {
                document.getElementById('hours_' + dateStr).textContent = '0.00';
            }
            
            updateTotals();
            saveData();
        }

        function updateTotals() {
            const monthStr = getCurrentMonth();
            const [year, month] = monthStr.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            let totalWorkedHours = 0;
            let totalHolidayHours = 0;
            let weekNumber = 1;
            let weekHours = 0;
            let weekHolidays = 0;
            
            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                
                const dateStr = date.toISOString().split('T')[0];
                const hoursElement = document.getElementById('hours_' + dateStr);
                const holidayElement = document.getElementById('holiday_' + dateStr);
                
                if (hoursElement && holidayElement) {
                    const dayHours = parseFloat(hoursElement.textContent) || 0;
                    const dayHolidays = parseFloat(holidayElement.value) || 0;
                    
                    totalWorkedHours += dayHours;
                    totalHolidayHours += dayHolidays;
                    weekHours += dayHours;
                    weekHolidays += dayHolidays;
                }
                
                if (dayOfWeek === 5 || date.getTime() === lastDay.getTime()) {
                    const weekTotalEl = document.getElementById('weekTotal_' + weekNumber);
                    const weekHolidayEl = document.getElementById('weekHoliday_' + weekNumber);
                    
                    if (weekTotalEl) weekTotalEl.textContent = weekHours.toFixed(2);
                    if (weekHolidayEl) weekHolidayEl.textContent = weekHolidays.toFixed(2);
                    
                    weekNumber++;
                    weekHours = 0;
                    weekHolidays = 0;
                }
            }
            
            const carriedForwardElement = document.getElementById('carriedForwardHours');
            const manualCarryForwardElement = document.getElementById('manualCarryForward');
            
            const carriedForwardHours = carriedForwardElement ? parseFloat(carriedForwardElement.value) || 0 : 0;
            const manualCarryForward = manualCarryForwardElement ? parseFloat(manualCarryForwardElement.value) || 0 : 0;
            
            const workingDays = countWorkingDaysInMonth(year, month - 1);
            const expectedWeeks = workingDays / 5;
            const contractExpectedHours = expectedWeeks * CONTRACT_HOURS_PER_WEEK;
            const overtimeTotal = Math.max(0, totalWorkedHours - contractExpectedHours);
            
            const offsetAgainstCarriedForward = Math.min(overtimeTotal, carriedForwardHours);
            const remainingCarriedForward = Math.max(0, carriedForwardHours - offsetAgainstCarriedForward);
            const overtimeAfterCarriedForwardOffset = Math.max(0, overtimeTotal - offsetAgainstCarriedForward);
            
            const offsetAgainstCurrentHoliday = Math.min(overtimeAfterCarriedForwardOffset, totalHolidayHours);
            const currentMonthNetHoliday = Math.max(0, totalHolidayHours - offsetAgainstCurrentHoliday);
            const finalRemainingOvertime = Math.max(0, overtimeAfterCarriedForwardOffset - offsetAgainstCurrentHoliday);
            
            const carryForwardToNext = manualCarryForward > 0 ? manualCarryForward : currentMonthNetHoliday;
            
            let netHolidayPayThisMonth;
            if (manualCarryForward > 0) {
                netHolidayPayThisMonth = remainingCarriedForward + Math.max(0, currentMonthNetHoliday - manualCarryForward);
            } else {
                netHolidayPayThisMonth = remainingCarriedForward + currentMonthNetHoliday;
            }
            
            const totalHolidayOffset = offsetAgainstCarriedForward + offsetAgainstCurrentHoliday;
            
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };
            
            updateElement('totalHours', totalWorkedHours.toFixed(2));
            updateElement('overtimeHours', overtimeTotal.toFixed(2));
            updateElement('currentHolidayHours', totalHolidayHours.toFixed(2));
            updateElement('netHolidayHours', netHolidayPayThisMonth.toFixed(2));
            updateElement('totalPay', ((totalWorkedHours + netHolidayPayThisMonth) * HOURLY_RATE).toFixed(2));
            
            updateElement('displayCarriedForward', carriedForwardHours.toFixed(2));
            updateElement('holidayOffset', totalHolidayOffset.toFixed(2));
            updateElement('carryForwardNext', carryForwardToNext.toFixed(2));
            updateElement('finalOvertime', finalRemainingOvertime.toFixed(2));
            
            updateElement('submissionHours', totalWorkedHours.toFixed(2));
            updateElement('submissionPay', (totalWorkedHours * HOURLY_RATE).toFixed(2));
            updateElement('submissionHolidayPay', (netHolidayPayThisMonth * HOURLY_RATE).toFixed(2));
            updateElement('submissionTotal', ((totalWorkedHours + netHolidayPayThisMonth) * HOURLY_RATE).toFixed(2));
            
            updateElement('holidaysRemaining', ANNUAL_HOLIDAY_DAYS.toString());
            
            saveMonthlyData(monthStr, {
                workedHours: totalWorkedHours,
                holidayHours: totalHolidayHours,
                overtimeHours: overtimeTotal,
                grossPay: (totalWorkedHours + netHolidayPayThisMonth) * HOURLY_RATE,
                carryForward: carryForwardToNext
            });
        }

        function saveData() {
            const monthStr = getCurrentMonth();
            const data = {};
            
            const inputs = document.querySelectorAll('input[type="time"], input[type="number"], input[type="text"]');
            inputs.forEach(input => {
                if (input.value) {
                    data[input.id] = input.value;
                }
            });
            
            localStorage.setItem('timesheet_' + monthStr, JSON.stringify(data));
        }

        function loadSavedData() {
            const monthStr = getCurrentMonth();
            const savedData = localStorage.getItem('timesheet_' + monthStr);
            
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.keys(data).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = data[id];
                        if (id.indexOf('timeIn_') !== -1 || id.indexOf('timeOut_') !== -1) {
                            const dateStr = id.split('_')[1];
                            calculateHours(dateStr);
                        }
                    }
                });
            }
        }

        function saveMonthlyData(month, summary) {
            const existingData = JSON.parse(localStorage.getItem('monthly_summaries') || '{}');
            existingData[month] = summary;
            localStorage.setItem('monthly_summaries', JSON.stringify(existingData));
        }

        function getAllMonthlyData() {
            return JSON.parse(localStorage.getItem('monthly_summaries') || '{}');
        }

        function updateDashboard() {
            const allData = getAllMonthlyData();
            const currentYear = new Date().getFullYear();
            
            let ytdHours = 0;
            let ytdEarnings = 0;
            let monthCount = 0;
            
            Object.keys(allData).forEach(month => {
                const [year] = month.split('-').map(Number);
                if (year === currentYear) {
                    const data = allData[month];
                    ytdHours += data.workedHours || 0;
                    ytdEarnings += data.grossPay || 0;
                    monthCount++;
                }
            });
            
            document.getElementById('ytdHours').textContent = ytdHours.toFixed(0);
            document.getElementById('ytdEarnings').textContent = '£' + ytdEarnings.toFixed(0);
            document.getElementById('holidayBalance').textContent = document.getElementById('holidaysRemaining').textContent;
            document.getElementById('avgWeekly').textContent = monthCount > 0 ? (ytdHours / (monthCount * 4.33)).toFixed(1) : '0';
            
            const tbody = document.getElementById('monthlyOverviewBody');
            tbody.innerHTML = '';
            
            const sortedMonths = Object.keys(allData).sort().reverse().slice(0, 12);
            if (sortedMonths.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No data available yet. Start entering timesheet data to see summaries.</td></tr>';
                return;
            }
            
            sortedMonths.forEach(month => {
                const data = allData[month];
                const row = document.createElement('tr');
                const monthName = new Date(month + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                
                row.innerHTML = '<td>' + monthName + '</td>' +
                    '<td>' + (data.workedHours || 0).toFixed(2) + '</td>' +
                    '<td>' + (data.holidayHours || 0).toFixed(2) + '</td>' +
                    '<td>' + (data.overtimeHours || 0).toFixed(2) + '</td>' +
                    '<td>£' + (data.grossPay || 0).toFixed(2) + '</td>';
                tbody.appendChild(row);
            });
        }

        function generateAnnualReport() {
            const year = document.getElementById('yearSelect').value;
            const allData = getAllMonthlyData();
            const reportContent = document.getElementById('annualReportContent');
            
            let annualHours = 0;
            let annualEarnings = 0;
            let annualHolidayHours = 0;
            let annualOvertimeHours = 0;
            let monthsWorked = 0;
            
            const monthlyData = [];
            
            for (let month = 1; month <= 12; month++) {
                const monthKey = year + '-' + String(month).padStart(2, '0');
                const data = allData[monthKey];
                
                if (data) {
                    annualHours += data.workedHours || 0;
                    annualEarnings += data.grossPay || 0;
                    annualHolidayHours += data.holidayHours || 0;
                    annualOvertimeHours += data.overtimeHours || 0;
                    monthsWorked++;
                    
                    monthlyData.push({
                        month: new Date(monthKey + '-01').toLocaleDateString('en-GB', { month: 'long' }),
                        ...data
                    });
                }
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">';
            html += '<div class="card"><h4>Total Hours</h4><div class="metric" style="font-size: 1.5em;">' + annualHours.toFixed(0) + '</div></div>';
            html += '<div class="card"><h4>Total Earnings</h4><div class="metric" style="font-size: 1.5em;">£' + annualEarnings.toFixed(0) + '</div></div>';
            html += '<div class="card"><h4>Holiday Hours</h4><div class="metric" style="font-size: 1.5em;">' + annualHolidayHours.toFixed(0) + '</div></div>';
            html += '<div class="card"><h4>Overtime Hours</h4><div class="metric" style="font-size: 1.5em;">' + annualOvertimeHours.toFixed(0) + '</div></div>';
            html += '</div>';
            
            if (monthlyData.length > 0) {
                html += '<table class="data-table">';
                html += '<thead><tr><th>Month</th><th>Hours</th><th>Holiday</th><th>Overtime</th><th>Gross Pay</th></tr></thead><tbody>';
                
                monthlyData.forEach(month => {
                    html += '<tr>';
                    html += '<td>' + month.month + '</td>';
                    html += '<td>' + (month.workedHours || 0).toFixed(2) + '</td>';
                    html += '<td>' + (month.holidayHours || 0).toFixed(2) + '</td>';
                    html += '<td>' + (month.overtimeHours || 0).toFixed(2) + '</td>';
                    html += '<td>£' + (month.grossPay || 0).toFixed(2) + '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            } else {
                html += '<p>No data available for ' + year + '</p>';
            }
            
            reportContent.innerHTML = html;
        }

        function updateDataOverview() {
            const allData = getAllMonthlyData();
            const overview = document.getElementById('dataOverview');
            
            let html = '<h4>Stored Data Overview</h4>';
            html += '<p>Total months with data: ' + Object.keys(allData).length + '</p>';
            
            if (Object.keys(allData).length > 0) {
                html += '<table class="data-table">';
                html += '<thead><tr><th>Month</th><th>Hours</th><th>Earnings</th><th>Status</th></tr></thead><tbody>';
                
                Object.keys(allData).sort().reverse().forEach(month => {
                    const data = allData[month];
                    const monthName = new Date(month + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    
                    html += '<tr>';
                    html += '<td>' + monthName + '</td>';
                    html += '<td>' + (data.workedHours || 0).toFixed(2) + '</td>';
                    html += '<td>£' + (data.grossPay || 0).toFixed(2) + '</td>';
                    html += '<td>Stored Locally</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            } else {
                html += '<p>No monthly summaries available. Enter timesheet data to see summaries.</p>';
            }
            
            overview.innerHTML = html;
        }

        function exportAllData() {
            const allTimesheet = {};
            const allSummaries = getAllMonthlyData();
            
            for (let key in localStorage) {
                if (key.startsWith('timesheet_')) {
                    allTimesheet[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            
            const exportData = {
                timesheets: allTimesheet,
                summaries: allSummaries,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Wendy_Ballard_Complete_Data_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(link);
            
            showStatus('All data exported successfully!', 'success');
        }

        function exportAnnualCSV() {
            const year = prompt('Enter year to export (e.g., 2025):');
            if (!year) return;
            
            const allData = getAllMonthlyData();
            let csv = 'Month,Hours Worked,Holiday Hours,Overtime Hours,Gross Pay\n';
            
            for (let month = 1; month <= 12; month++) {
                const monthKey = year + '-' + String(month).padStart(2, '0');
                const data = allData[monthKey];
                
                if (data) {
                    const monthName = new Date(monthKey + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    csv += monthName + ',' + 
                           (data.workedHours || 0).toFixed(2) + ',' + 
                           (data.holidayHours || 0).toFixed(2) + ',' + 
                           (data.overtimeHours || 0).toFixed(2) + ',' + 
                           (data.grossPay || 0).toFixed(2) + '\n';
                }
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Wendy_Ballard_Annual_' + year + '.csv';
            link.click();
            URL.revokeObjectURL(link);
            
            showStatus('Annual CSV exported successfully!', 'success');
        }

        function generateCSV() {
            const monthStr = getCurrentMonth();
            const [year, month] = monthStr.split('-').map(Number);
            const monthName = new Date(year, month - 1).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            
            let csv = 'Date,Day,Time In,Time Out,Hours Worked,Holiday Hours,Comments\n';
            
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-GB', { weekday: 'long' });
                const dateFormat = date.toLocaleDateString('en-GB');
                
                const timeInElement = document.getElementById('timeIn_' + dateStr);
                const timeOutElement = document.getElementById('timeOut_' + dateStr);
                const hoursElement = document.getElementById('hours_' + dateStr);
                const holidayElement = document.getElementById('holiday_' + dateStr);
                const commentsElement = document.getElementById('comments_' + dateStr);
                
                const timeIn = timeInElement ? timeInElement.value : '';
                const timeOut = timeOutElement ? timeOutElement.value : '';
                const hours = hoursElement ? hoursElement.textContent : '0.00';
                const holiday = holidayElement ? holidayElement.value : '';
                const comments = commentsElement ? commentsElement.value.replace(/"/g, '""') : '';
                
                csv += dateFormat + ',' + dayName + ',' + timeIn + ',' + timeOut + ',' + hours + ',' + holiday + ',"' + comments + '"\n';
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'Wendy_Ballard_Timesheet_' + monthName.replace(' ', '_') + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showStatus('Monthly CSV exported successfully!', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a file to import', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.timesheets) {
                        Object.keys(data.timesheets).forEach(key => {
                            localStorage.setItem(key, JSON.stringify(data.timesheets[key]));
                        });
                    }
                    
                    if (data.summaries) {
                        localStorage.setItem('monthly_summaries', JSON.stringify(data.summaries));
                    }
                    
                    showStatus('Data imported successfully!', 'success');
                    generateTimesheet();
                    updateDashboard();
                } catch (error) {
                    showStatus('Error importing data: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function createBackup() {
            exportAllData();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                if (confirm('This will delete all timesheets and summaries. Are you absolutely sure?')) {
                    for (let key in localStorage) {
                        if (key.startsWith('timesheet_') || key === 'monthly_summaries') {
                            localStorage.removeItem(key);
                        }
                    }
                    showStatus('All data cleared!', 'success');
                    generateTimesheet();
                    updateDashboard();
                }
            }
        }

        function printTimesheet() {
            const monthStr = getCurrentMonth();
            const [year, month] = monthStr.split('-').map(Number);
            const monthName = new Date(year, month - 1).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            
            let printHtml = '<!DOCTYPE html><html><head><title>Timesheet - ' + monthName + '</title>';
            printHtml += '<style>body{font-family:Arial,sans-serif;margin:20px;font-size:14px;}h1{color:#2c3e50;text-align:center;}table{width:100%;border-collapse:collapse;margin:20px 0;}th,td{border:1px solid #000;padding:8px;text-align:center;}th{background-color:#c9daf8;font-weight:bold;}.date-cell{text-align:left;background-color:#f8f9fa;font-weight:bold;}.week-total{background-color:#d1ecf1;font-weight:bold;}.summary{margin-top:30px;border-top:2px solid #4CAF50;padding-top:20px;}@media print{body{margin:10px;}}</style>';
            printHtml += '</head><body><h1>Wendy Ballard - Timesheet for ' + monthName + '</h1><table><tr><th>Date</th><th>Time In</th><th>Time Out</th><th>Hours</th><th>Holiday</th><th>Comments</th></tr>';
            
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            let weekHours = 0;
            let weekHoliday = 0;
            let weekNumber = 1;
            
            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-GB', { weekday: 'long' });
                const dayDate = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'numeric' });
                
                const timeInEl = document.getElementById('timeIn_' + dateStr);
                const timeOutEl = document.getElementById('timeOut_' + dateStr);
                const hoursEl = document.getElementById('hours_' + dateStr);
                const holidayEl = document.getElementById('holiday_' + dateStr);
                const commentsEl = document.getElementById('comments_' + dateStr);
                
                const timeIn = timeInEl ? timeInEl.value : '';
                const timeOut = timeOutEl ? timeOutEl.value : '';
                const hours = hoursEl ? hoursEl.textContent : '0.00';
                const holiday = holidayEl ? holidayEl.value : '';
                const comments = commentsEl ? commentsEl.value : '';
                
                weekHours += parseFloat(hours) || 0;
                weekHoliday += parseFloat(holiday) || 0;
                
                printHtml += '<tr><td class="date-cell">' + dayName + ', ' + dayDate + '</td><td>' + timeIn + '</td><td>' + timeOut + '</td><td>' + hours + '</td><td>' + holiday + '</td><td>' + comments + '</td></tr>';
                
                if (dayOfWeek === 5 || date.getTime() === lastDay.getTime()) {
                    printHtml += '<tr class="week-total"><td>Week ' + weekNumber + ' Total</td><td colspan="2"></td><td>' + weekHours.toFixed(2) + '</td><td>' + weekHoliday.toFixed(2) + '</td><td></td></tr>';
                    weekHours = 0;
                    weekHoliday = 0;
                    weekNumber++;
                }
            }
            
            const totalHours = document.getElementById('totalHours').textContent;
            const netHoliday = document.getElementById('netHolidayHours').textContent;
            const totalPay = document.getElementById('totalPay').textContent;
            const carriedForward = document.getElementById('displayCarriedForward').textContent;
            const carryForwardNext = document.getElementById('carryForwardNext').textContent;
            
            printHtml += '</table><div class="summary"><h3>Monthly Summary</h3><p><strong>Total Hours Worked:</strong> ' + totalHours + '</p><p><strong>Net Holiday Pay:</strong> ' + netHoliday + ' hours</p><p><strong>Total Gross Pay:</strong> £' + totalPay + '</p><p><strong>Carried Forward In:</strong> ' + carriedForward + ' hours</p><p><strong>Carry Forward Out:</strong> ' + carryForwardNext + ' hours</p><p><strong>Rate:</strong> £23.00/hour</p></div></body></html>';
            
            const blob = new Blob([printHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Wendy_Ballard_Timesheet_' + monthName.replace(' ', '_') + '_Printable.html';
            link.click();
            URL.revokeObjectURL(url);
            
            showStatus('Printable timesheet downloaded! Open the HTML file and use Ctrl+P (or Cmd+P) to print.', 'success');
        }

        generateTimesheet();
    </script>
</body>
</html>
